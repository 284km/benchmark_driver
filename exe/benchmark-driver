#!/usr/bin/env ruby
$:.unshift File.expand_path('../lib', __dir__)

require 'benchmark_driver'
require 'optparse'
require 'yaml'

#
# Parse command line options
#
paths = []
filters = []
driver_type = 'default'
parsed_config = BenchmarkDriver::Config.new.tap do |config|
  bundler = false
  parser = OptionParser.new do |o|
    o.banner = "Usage: #{File.basename($0, '.*')} [options] [YAML]"
    o.on('-d', '--driver [TYPE]', 'Specify driver type (default, memory, custom)') do |d|
      abort '-d, --driver must take argument but not given' if d.nil?
      driver_type = d
    end
    o.on('-o', '--output [TYPE]', 'Specify output type (default, simple, markdown) (TODO)') do |o|
      abort '-o, --output must take argument but not given' if o.nil?
      config.output = o
    end
    o.on('-e', '--executables [EXECS]', 'Ruby executables (e1::path1,arg1,...; e2::path2,arg2;...)') do |e|
      abort '--executable must take argument but not given' if e.nil?
      e.split(';').each do |name_path|
        name, path = name_path.split('::', 2)
        config.execs << BenchmarkDriver::Config::Executable.new(
          name: name,
          command: path ? path.split(',') : [name],
        )
      end
    end
    o.on('--rbenv [VERSIONS]', 'Ruby executables in rbenv (x.x.x,arg1,...;y.y.y,arg2,...;...)') do |r|
      abort '--rbenv must take argument but not given' if r.nil?
      r.split(';').each do |spec|
        version, *args = spec.split(',')
        config.execs << BenchmarkDriver::Config::Executable.new(
          name: version,
          command: [Rbenv.ruby_path(version), *args],
        )
      end
    end
    o.on('--repeat-count [NUM]', 'Try benchmark NUM times and use the fastest result (TODO)') do |v|
      begin
        config.repeat_count = Integer(v)
      rescue ArgumentError
        abort "-r, --repeat-count must take Integer, but got #{v.inspect}"
      end
    end
    o.on('--filter [REGEXP]', 'Filter out benchmarks with given regexp') do |v|
      filters << Regexp.compile(v)
    end
    o.on('--bundler', 'Install and use gems specified in Gemfile') do |v|
      bundler = v
    end
  end
  paths = parser.parse!(ARGV)
  if paths.empty?
    abort "No YAML file is specified!\n\n#{parser.help}"
  end

  # Configs that need to be set lazily
  if config.execs.empty?
    config.execs = [BenchmarkDriver::Config::Executable.new(name: RUBY_VERSION, command: [RbConfig.ruby])]
  end
  if bundler
    config.execs.each do |exec|
      exec.command << '-rbundler/setup'
    end
  end

  config.freeze
end

#
# Parse benchmark job definitions
#
jobs = paths.flat_map do |path|
  job = YAML.load(File.read(path))
  job = { 'type' => driver_type }.merge!(job)

  begin
    BenchmarkDriver::JobParser.parse(job)
  rescue ArgumentError
    $stderr.puts "benchmark-driver: Failed to parse #{path.dump}."
    $stderr.puts '  YAML format may be wrong. See error below:'
    $stderr.puts
    raise
  end
end.select do |job|
  filters.all? do |filter|
    job.name.match(filter)
  end
end

BenchmarkDriver::JobRunner.run(jobs, config: parsed_config)
